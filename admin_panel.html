<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Ruleta Dorada Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: 200px 0;
            }
        }

        @keyframes levelGlow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            }
        }

        @keyframes recordingPulse {
            0%, 100% {
                border-color: #ff4444;
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
            }
            50% {
                border-color: #ff8888;
                box-shadow: 0 0 40px rgba(255, 68, 68, 0.8);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .header h1 {
            color: #3498db;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .header p {
            color: white;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .quick-action {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .quick-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .quick-action.backup {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .quick-action.export {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .panel h3 {
            color: #3498db;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: white;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            transition: border-color 0.3s ease;
        }

        .form-group input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            background: rgba(255, 255, 255, 0.95);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #219a52);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Sistema de niveles */
        .nivel-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
            animation: levelGlow 3s infinite;
        }

        .nivel-1 {
            background: linear-gradient(45deg, #CD7F32, #A0522D);
            color: white;
            border: 2px solid #CD7F32;
        }

        .nivel-2 {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
            border: 2px solid #FFD700;
        }

        .nivel-3 {
            background: linear-gradient(45deg, #1E90FF, #0066CC);
            color: white;
            border: 2px solid #1E90FF;
        }

        .nivel-4 {
            background: linear-gradient(45deg, #C0C0C0, #A9A9A9);
            color: #333;
            border: 2px solid #C0C0C0;
        }

        .nivel-5 {
            background: linear-gradient(45deg, #FF1493, #9932CC, #00CED1, #FFD700);
            background-size: 300% 300%;
            animation: shimmer 2s infinite, levelGlow 2s infinite;
            color: white;
            border: 2px solid #FFD700;
        }

        .participants-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .participant-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .participant-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(10px);
        }

        .participant-info {
            color: white;
            flex-grow: 1;
        }

        .participant-info strong {
            color: #3498db;
        }

        .participant-level {
            margin: 5px 0;
        }

        .participant-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.3);
            color: #f39c12;
        }

        .status-verified {
            background: rgba(39, 174, 96, 0.3);
            color: #27ae60;
        }

        .status-banned {
            background: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }

        .sorteo-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: white;
            opacity: 0.8;
        }

        .results-table {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .results-table th, .results-table td {
            padding: 12px;
            text-align: left;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-table th {
            background: rgba(52, 152, 219, 0.3);
            font-weight: bold;
        }

        .results-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .ruleta-preview {
            width: 350px;
            height: 350px;
            border-radius: 50%;
            border: 6px solid #3498db;
            margin: 0 auto 20px;
            position: relative;
            background: conic-gradient(
                #FF6B6B 0deg,
                #4ECDC4 36deg,
                #45B7D1 72deg,
                #96CEB4 108deg,
                #FFEAA7 144deg,
                #DDA0DD 180deg,
                #98D8C8 216deg,
                #F7DC6F 252deg,
                #BB8FCE 288deg,
                #85C1E9 324deg
            );
            transition: transform 4s cubic-bezier(0.23, 1, 0.320, 1);
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.3);
        }

        .ruleta-preview.spinning {
            transform: rotate(2160deg);
        }

        .ruleta-preview.recording {
            animation: recordingPulse 1s infinite;
        }

        .numero-slot-preview {
            position: absolute;
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #3498db;
            transition: all 0.3s ease;
        }

        .numero-slot-preview:hover {
            transform: scale(1.2);
        }

        .numero-slot-preview.ocupado {
            background: #27ae60;
            color: white;
        }

        .numero-slot-preview.pendiente {
            background: #f39c12;
            color: white;
        }

        .pointer-preview {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 40px solid #e74c3c;
            z-index: 10;
        }

        .winner-display {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(39, 174, 96, 0.2);
            border: 2px solid rgba(39, 174, 96, 0.5);
            border-radius: 15px;
            display: none;
        }

        .winner-display.show {
            display: block;
            animation: pulse 2s infinite;
        }

        .winner-display h4 {
            color: #27ae60;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .recording-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .recording-status {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ff4444;
            display: none;
        }

        .recording-status.active {
            display: block;
            animation: pulse 1s infinite;
        }

        .gif-preview {
            max-width: 100%;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .two-columns {
            grid-column: 1 / 3;
        }

        .level-management {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .level-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .level-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .level-title {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-benefits {
            color: white;
            font-size: 12px;
            text-align: left;
            margin: 10px 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.3s ease;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin: 2% auto;
            padding: 30px;
            border-radius: 25px;
            width: 90%;
            max-width: 800px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 0.5s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8em;
        }

        .modal .form-group label {
            color: #333;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: white;
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .sorteo-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .ruleta-preview {
                width: 280px;
                height: 280px;
            }

            .admin-actions {
                flex-direction: column;
                align-items: center;
            }

            .participant-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 1.5s infinite;
        }

        .sparkle {
            position: relative;
            overflow: hidden;
        }

        .sparkle::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%);
            animation: sparkle 3s infinite;
        }

        @keyframes sparkle {
            0% { transform: rotate(0deg) scale(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: rotate(360deg) scale(1); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚öôÔ∏è Panel de Administraci√≥n Pro</h1>
            <p>Sistema avanzado de gesti√≥n para Ruleta Dorada</p>
            <div class="admin-actions">
                <button class="quick-action backup" onclick="respaldarDatos()">üíæ Respaldar Datos</button>
                <button class="quick-action export" onclick="exportarEstadisticas()">üìä Exportar Stats</button>
                <button class="quick-action" onclick="limpiarHistorial()">üóëÔ∏è Limpiar Historial</button>
                <button class="quick-action" onclick="abrirGestionNiveles()">üèÜ Gesti√≥n Niveles</button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statParticipantes">--</div>
                <div class="stat-label">Participantes Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statVerificados">--</div>
                <div class="stat-label">Verificados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statIngresos">$--</div>
                <div class="stat-label">Ingresos Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statDisponibles">--</div>
                <div class="stat-label">N√∫meros Disponibles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statNivelPromedio">--</div>
                <div class="stat-label">Nivel Promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statJugadoresVIP">--</div>
                <div class="stat-label">Jugadores VIP</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Configuraci√≥n de Sorteo -->
            <div class="panel">
                <h3>‚öôÔ∏è Configuraci√≥n de Sorteo</h3>
                <form id="sorteoForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cantidad de N√∫meros (5-50):</label>
                            <input type="number" id="cantidadNumeros" min="5" max="50" value="10" required>
                        </div>
                        <div class="form-group">
                            <label>Premio (USD):</label>
                            <input type="number" id="premioSorteo" value="80" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha del Sorteo:</label>
                            <input type="date" id="fechaSorteo" required>
                        </div>
                        <div class="form-group">
                            <label>Hora del Sorteo:</label>
                            <input type="time" id="horaSorteo" value="20:00" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Sorteo:</label>
                        <select id="tipoSorteo">
                            <option value="normal">üé≤ Sorteo Normal</option>
                            <option value="vip">üëë Sorteo VIP (Solo ORO+)</option>
                            <option value="especial">üíé Sorteo Especial</option>
                        </select>
                    </div>
                    <div class="sorteo-controls">
                        <button type="submit" class="btn btn-success">üîß Configurar Nuevo Sorteo</button>
                        <button type="button" class="btn btn-warning" onclick="pausarSorteo()">‚è∏Ô∏è Pausar Sorteo</button>
                        <button type="button" class="btn btn-danger" onclick="finalizarSorteo()">üèÅ Finalizar Sorteo</button>
                    </div>
                </form>
            </div>

            <!-- Control de Sorteo con Grabaci√≥n -->
            <div class="panel">
                <h3>üé≤ Control de Sorteo Avanzado</h3>
                <div class="ruleta-preview" id="ruletaPreview">
                    <div class="pointer-preview"></div>
                </div>

                <div class="recording-status" id="recordingStatus">
                    üî¥ GRABANDO - Preparando GIF del sorteo...
                </div>
                
                <div class="winner-display" id="winnerDisplay">
                    <h4>üéâ ¬°GANADOR! üéâ</h4>
                    <p id="winnerText"></p>
                </div>

                <div class="gif-preview">
                    <img id="gifResult" class="gif-preview" alt="GIF del sorteo">
                </div>
                
                <div class="recording-controls">
                    <button class="btn btn-warning" onclick="iniciarGrabacion()" id="btnIniciarGrabacion">
                        üìπ Iniciar Grabaci√≥n
                    </button>
                    <button class="btn btn-success" onclick="girarRuletaConGrabacion()" id="btnGirarGrabando" disabled>
                        üé¨ Girar y Grabar
                    </button>
                    <button class="btn" onclick="generarRuletaPreview()">
                        üîÑ Actualizar Vista
                    </button>
                </div>
            </div>

            <!-- Sistema de Niveles -->
            <div class="panel">
                <h3>üèÜ Sistema Golden Players</h3>
                <div class="level-grid" id="levelGrid">
                    <!-- Los niveles se cargar√°n din√°micamente -->
                </div>
                <div class="sorteo-controls">
                    <button class="btn btn-success" onclick="recalcularNiveles()">üîÑ Recalcular Niveles</button>
                    <button class="btn btn-warning" onclick="otorgarBeneficios()">üéÅ Otorgar Beneficios</button>
                </div>
            </div>
        </div>

        <!-- Gesti√≥n Avanzada de Participantes -->
        <div class="panel full-width">
            <h3>üë• Gesti√≥n Avanzada de Participantes</h3>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <input type="text" id="buscarParticipante" placeholder="üîç Buscar por nombre, tel√©fono o n√∫mero...">
                </div>
                <div class="form-group">
                    <select id="filtroNivel">
                        <option value="">Todos los niveles</option>
                        <option value="1">üèÖ Bronce</option>
                        <option value="2">‚ö°Ô∏è Plata</option>
                        <option value="3">üî• Oro</option>
                        <option value="4">üëë Platino</option>
                        <option value="5">üíé Diamante</option>
                    </select>
                </div>
            </div>
            <div class="participants-list" id="participantsList">
                <p style="color: white; opacity: 0.7; text-align: center;">Cargando participantes...</p>
            </div>
        </div>

        <!-- Historial y Estad√≠sticas -->
        <div class="panel full-width">
            <h3>üìä Historial y Analytics</h3>
            <div class="form-row">
                <div class="form-group">
                    <input type="date" id="fechaDesde" placeholder="Fecha desde">
                </div>
                <div class="form-group">
                    <input type="date" id="fechaHasta" placeholder="Fecha hasta">
                </div>
                <div class="form-group">
                    <button class="btn" onclick="filtrarHistorial()">üìÖ Filtrar</button>
                </div>
            </div>
            <table class="results-table" id="historialTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Tipo</th>
                        <th>Participantes</th>
                        <th>Ganador</th>
                        <th>N√∫mero</th>
                        <th>Premio</th>
                        <th>Nivel Ganador</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="10" style="text-align: center; opacity: 0.7;">Cargando historial...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal de Gesti√≥n de Niveles -->
    <div id="nivelesModal" class="modal">
        <div class="modal-content">
            <h3>üèÜ Gesti√≥n del Sistema Golden Players</h3>
            
            <div class="level-management">
                <h4 style="color: #FFD700; text-align: center; margin-bottom: 20px;">Configuraci√≥n de Niveles</h4>
                
                <div class="level-grid">
                    <div class="level-card nivel-1">
                        <div class="level-title">üèÖ NIVEL 1 - BRONCE</div>
                        <div class="nivel-badge nivel-1">üèÖ BRONCE ü•â</div>
                        <div class="level-benefits">
                            <strong>Requisitos:</strong> 1-4 participaciones<br>
                            <strong>Beneficios:</strong><br>
                            ‚Ä¢ 1 n√∫mero GRATIS cada 10 sorteos<br>
                            ‚Ä¢ Notificaci√≥n 5 min antes<br>
                            ‚Ä¢ Grupo WhatsApp exclusivo
                        </div>
                        <div class="form-group">
                            <input type="number" id="nivel1Min" placeholder="Min participaciones" value="1">
                            <input type="number" id="nivel1Max" placeholder="Max participaciones" value="4">
                        </div>
                    </div>

                    <div class="level-card nivel-2">
                        <div class="level-title">‚ö°Ô∏è NIVEL 2 - PLATA</div>
                        <div class="nivel-badge nivel-2">‚ö°Ô∏è PLATA ü•à</div>
                        <div class="level-benefits">
                            <strong>Requisitos:</strong> 5-9 participaciones<br>
                            <strong>Beneficios:</strong><br>
                            ‚Ä¢ 1 n√∫mero GRATIS cada 5 sorteos<br>
                            ‚Ä¢ Reservar n√∫mero favorito 1h<br>
                            ‚Ä¢ Sorteo mensual $100
                        </div>
                        <div class="form-group">
                            <input type="number" id="nivel2Min" placeholder="Min participaciones" value="5">
                            <input type="number" id="nivel2Max" placeholder="Max participaciones" value="9">
                        </div>
                    </div>

                    <div class="level-card nivel-3">
                        <div class="level-title">üî• NIVEL 3 - ORO</div>
                        <div class="nivel-badge nivel-3">üî• ORO ü•á</div>
                        <div class="level-benefits">
                            <strong>Requisitos:</strong> 10-19 participaciones<br>
                            <strong>Beneficios:</strong><br>
                            ‚Ä¢ 2 n√∫meros GRATIS por semana<br>
                            ‚Ä¢ Club VIP Escalera del Dinero<br>
                            ‚Ä¢ Descuento 20%<br>
                            ‚Ä¢ Estad√≠sticas personales
                        </div>
                        <div class="form-group">
                            <input type="number" id="nivel3Min" placeholder="Min participaciones" value="10">
                            <input type="number" id="nivel3Max" placeholder="Max participaciones" value="19">
                        </div>
                    </div>

                    <div class="level-card nivel-4">
                        <div class="level-title">üëë NIVEL 4 - PLATINO</div>
                        <div class="nivel-badge nivel-4">üëë PLATINO üíé</div>
                        <div class="level-benefits">
                            <strong>Requisitos:</strong> 20-49 participaciones<br>
                            <strong>Beneficios:</strong><br>
                            ‚Ä¢ Acceso VIP exclusivo<br>
                            ‚Ä¢ Descuentos especiales<br>
                            ‚Ä¢ Sorteos premium<br>
                            ‚Ä¢ Soporte prioritario
                        </div>
                        <div class="form-group">
                            <input type="number" id="nivel4Min" placeholder="Min participaciones" value="20">
                            <input type="number" id="nivel4Max" placeholder="Max participaciones" value="49">
                        </div>
                    </div>

                    <div class="level-card nivel-5 sparkle">
                        <div class="level-title">üíé NIVEL 5 - DIAMANTE</div>
                        <div class="nivel-badge nivel-5">üíé DIAMANTE üåà</div>
                        <div class="level-benefits">
                            <strong>Requisitos:</strong> 50+ participaciones<br>
                            <strong>Beneficios:</strong><br>
                            ‚Ä¢ Beneficios √âLITE<br>
                            ‚Ä¢ Sorteos exclusivos mensuales<br>
                            ‚Ä¢ Premios f√≠sicos<br>
                            ‚Ä¢ Reconocimiento especial
                        </div>
                        <div class="form-group">
                            <input type="number" id="nivel5Min" placeholder="Min participaciones" value="50">
                            <input type="text" id="nivel5Max" placeholder="Sin l√≠mite" value="‚àû" readonly>
                        </div>
                    </div>
                </div>

                <div class="sorteo-controls">
                    <button class="btn btn-success" onclick="guardarConfigNiveles()">üíæ Guardar Configuraci√≥n</button>
                    <button class="btn btn-warning" onclick="resetearNiveles()">üîÑ Resetear a Default</button>
                    <button class="btn btn-danger" onclick="cerrarNivelesModal()">‚ùå Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n de Participante -->
    <div id="editParticipantModal" class="modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Editar Participante</h3>
            <form id="editParticipantForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre Completo:</label>
                        <input type="text" id="editNombre" required>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono:</label>
                        <input type="text" id="editTelefono" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nivel:</label>
                        <select id="editNivel">
                            <option value="1">üèÖ Bronce</option>
                            <option value="2">‚ö°Ô∏è Plata</option>
                            <option value="3">üî• Oro</option>
                            <option value="4">üëë Platino</option>
                            <option value="5">üíé Diamante</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Participaciones Totales:</label>
                        <input type="number" id="editParticipaciones" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado de Pago:</label>
                        <select id="editEstado">
                            <option value="pendiente">‚è≥ Pendiente de Pago</option>
                            <option value="verificado">‚úÖ Pago Verificado</option>
                            <option value="baneado">üö´ Baneado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>N√∫meros Gratis Disponibles:</label>
                        <input type="number" id="editNumerosGratis" min="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notas de Admin:</label>
                    <textarea id="editNotas" rows="3" placeholder="Notas internas sobre el participante..."></textarea>
                </div>
                <div class="sorteo-controls">
                    <button type="submit" class="btn btn-success">üíæ Guardar Cambios</button>
                    <button type="button" class="btn btn-danger" onclick="cerrarEditModal()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 GStar INK. Panel de Administraci√≥n Avanzado - Todos los derechos reservados.</p>
    </footer>

    <!-- Firebase Configuration y JavaScript -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, setDoc, query, orderBy, limit, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDH0eto3duCUC3y2VF-5NJiq70i8OLOXSY",
            authDomain: "ruleta-55bef.firebaseapp.com",
            projectId: "ruleta-55bef",
            storageBucket: "ruleta-55bef.firebasestorage.app",
            messagingSenderId: "314981215922",
            appId: "1:314981215922:web:bd6a2c445abbd5e697a3ab",
            measurementId: "G-7T07MJH0RF"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Variables globales
        let sorteoActual = null;
        let participantesData = {};
        let historialData = [];
        let participantesCompletos = {};
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let participanteEditando = null;

        // Sistema de niveles CORREGIDO
        const NIVELES_CONFIG = {
            1: {
                badge: 'üèÖ',
                nombre: 'BRONCE',
                emoji: 'ü•â',
                participaciones: [1, 4], // CORREGIDO: Ahora comienza desde 1
                beneficios: ['1 n√∫mero GRATIS cada 10 sorteos', 'Notificaci√≥n 5 min antes', 'Grupo WhatsApp exclusivo'],
                color: 'nivel-1'
            },
            2: {
                badge: '‚ö°Ô∏è',
                nombre: 'PLATA',
                emoji: 'ü•à',
                participaciones: [5, 9], // CORREGIDO: Rango ajustado
                beneficios: ['1 n√∫mero GRATIS cada 5 sorteos', 'Reservar n√∫mero favorito 1h', 'Sorteo mensual $100'],
                color: 'nivel-2'
            },
            3: {
                badge: 'üî•',
                nombre: 'ORO',
                emoji: 'ü•á',
                participaciones: [10, 19], // CORREGIDO: Rango ajustado
                beneficios: ['2 n√∫meros GRATIS por semana', 'Club VIP Escalera del Dinero', 'Descuento 20%', 'Estad√≠sticas personales'],
                color: 'nivel-3'
            },
            4: {
                badge: 'üëë',
                nombre: 'PLATINO',
                emoji: 'üíé',
                participaciones: [20, 49], // CORREGIDO: Rango ajustado
                beneficios: ['Acceso VIP exclusivo', 'Descuentos especiales', 'Sorteos premium', 'Soporte prioritario'],
                color: 'nivel-4'
            },
            5: {
                badge: 'üíé',
                nombre: 'DIAMANTE',
                emoji: 'üåà',
                participaciones: [50, Infinity],
                beneficios: ['Beneficios √âLITE', 'Sorteos exclusivos mensuales', 'Premios f√≠sicos', 'Reconocimiento especial'],
                color: 'nivel-5'
            }
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            inicializarAdmin();
            configurarFechaHora();
            configurarBuscador();
            cargarLevelGrid();
        });

        function configurarFechaHora() {
            let ahora = new Date();
            document.getElementById('fechaSorteo').value = ahora.toISOString().split('T')[0];
            document.getElementById('horaSorteo').value = '20:00';
            
            // Configurar filtros de fecha
            document.getElementById('fechaDesde').value = new Date(ahora.getTime() - 7*24*60*60*1000).toISOString().split('T')[0];
            document.getElementById('fechaHasta').value = ahora.toISOString().split('T')[0];
        }

        function configurarBuscador() {
            const buscador = document.getElementById('buscarParticipante');
            const filtroNivel = document.getElementById('filtroNivel');
            
            buscador.addEventListener('input', filtrarParticipantes);
            filtroNivel.addEventListener('change', filtrarParticipantes);
        }

        function filtrarParticipantes() {
            const busqueda = document.getElementById('buscarParticipante').value.toLowerCase();
            const nivelFiltro = document.getElementById('filtroNivel').value;
            
            const participantesItems = document.querySelectorAll('.participant-item');
            
            participantesItems.forEach(item => {
                const texto = item.textContent.toLowerCase();
                const nivelElement = item.querySelector('.nivel-badge');
                const nivelParticipante = nivelElement ? nivelElement.getAttribute('data-nivel') : '1';
                
                const coincideBusqueda = !busqueda || texto.includes(busqueda);
                const coincideNivel = !nivelFiltro || nivelParticipante === nivelFiltro;
                
                item.style.display = (coincideBusqueda && coincideNivel) ? 'flex' : 'none';
            });
        }

        function inicializarAdmin() {
            // Escuchar sorteo activo
            const sorteoRef = doc(db, 'sorteos', 'activo');
            onSnapshot(sorteoRef, (doc) => {
                if (doc.exists()) {
                    sorteoActual = doc.data();
                    actualizarInterfazAdmin();
                } else {
                    sorteoActual = null;
                    actualizarStats();
                }
            });

            // Escuchar participantes del sorteo actual
            const participantesRef = collection(db, 'participantes');
            onSnapshot(participantesRef, (snapshot) => {
                participantesData = {};
                snapshot.forEach((doc) => {
                    if (doc.data().sorteoId === 'activo') {
                        participantesData[doc.data().numeroSeleccionado] = {
                            ...doc.data(),
                            id: doc.id
                        };
                    }
                });
                actualizarParticipantes();
                actualizarStats();
                generarRuletaPreview();
            });

            // Escuchar todos los participantes para estad√≠sticas
            onSnapshot(collection(db, 'usuarios'), (snapshot) => {
                participantesCompletos = {};
                snapshot.forEach((doc) => {
                    participantesCompletos[doc.id] = doc.data();
                });
                actualizarStatsAvanzadas();
                cargarLevelGrid(); // CORREGIDO: Actualizar grid cuando cambien los datos
            });

            // Escuchar historial
            const historialQuery = query(
                collection(db, 'resultados'),
                orderBy('timestamp', 'desc'),
                limit(50)
            );
            onSnapshot(historialQuery, (snapshot) => {
                historialData = [];
                snapshot.forEach((doc) => {
                    historialData.push({ id: doc.id, ...doc.data() });
                });
                cargarHistorial();
            });
        }

        // FUNCI√ìN CORREGIDA: Calcular nivel basado en participaciones
        function calcularNivel(participaciones) {
            // CORREGIDO: Asegurar que siempre devuelve al menos nivel 1
            if (!participaciones || participaciones < 1) {
                return {
                    nivel: 1,
                    participaciones: participaciones || 0,
                    datos: NIVELES_CONFIG[1]
                };
            }

            for (let nivel in NIVELES_CONFIG) {
                const [min, max] = NIVELES_CONFIG[nivel].participaciones;
                if (participaciones >= min && participaciones <= max) {
                    return {
                        nivel: parseInt(nivel),
                        participaciones: participaciones,
                        datos: NIVELES_CONFIG[nivel]
                    };
                }
            }
            
            // Si no coincide con ning√∫n rango, devolver el m√°s alto
            return {
                nivel: 5,
                participaciones: participaciones,
                datos: NIVELES_CONFIG[5]
            };
        }

        // FUNCI√ìN CORREGIDA: Asignar nivel autom√°ticamente al registrarse
        function asignarNivelInicialUsuario(telefono) {
            return setDoc(doc(db, 'usuarios', telefono.replace(/\D/g, '')), {
                participacionesTotales: 1, // CORREGIDO: Empezar con 1 participaci√≥n
                nivel: 1, // CORREGIDO: Nivel inicial siempre 1 (Bronce)
                fechaRegistro: new Date(),
                ultimaParticipacion: new Date()
            }, { merge: true });
        }

        function actualizarInterfazAdmin() {
            if (!sorteoActual) return;

            // Actualizar formulario con datos actuales
            document.getElementById('cantidadNumeros').value = sorteoActual.cantidadNumeros;
            document.getElementById('premioSorteo').value = sorteoActual.premio;
            document.getElementById('fechaSorteo').value = sorteoActual.fecha;
            document.getElementById('horaSorteo').value = sorteoActual.hora;
            document.getElementById('tipoSorteo').value = sorteoActual.tipo || 'normal';

            generarRuletaPreview();
        }

        function actualizarStats() {
            const totalParticipantes = Object.keys(participantesData).length;
            const verificados = Object.values(participantesData).filter(p => p.pagoVerificado).length; // CORREGIDO: pagoVerificado en lugar de verificado
            const ingresos = verificados * 10;
            const disponibles = sorteoActual ? sorteoActual.cantidadNumeros - totalParticipantes : 0;

            document.getElementById('statParticipantes').textContent = totalParticipantes;
            document.getElementById('statVerificados').textContent = verificados;
            document.getElementById('statIngresos').textContent = `${ingresos}`;
            document.getElementById('statDisponibles').textContent = disponibles;
        }

        function actualizarStatsAvanzadas() {
            let nivelPromedio = 0;
            let jugadoresVIP = 0;
            let totalUsuarios = Object.keys(participantesCompletos).length;

            if (totalUsuarios > 0) {
                Object.values(participantesCompletos).forEach(usuario => {
                    const participaciones = usuario.participacionesTotales || 1; // CORREGIDO: M√≠nimo 1
                    const nivel = calcularNivel(participaciones).nivel;
                    nivelPromedio += nivel;
                    
                    if (nivel >= 3) jugadoresVIP++; // ORO y superior
                });
                
                nivelPromedio = (nivelPromedio / totalUsuarios).toFixed(1);
            }

            document.getElementById('statNivelPromedio').textContent = nivelPromedio || '1.0';
            document.getElementById('statJugadoresVIP').textContent = jugadoresVIP || '0';
        }

        // FUNCI√ìN CORREGIDA: Cargar grid de niveles con datos reales
        function cargarLevelGrid() {
            const levelGrid = document.getElementById('levelGrid');
            levelGrid.innerHTML = '';

            Object.entries(NIVELES_CONFIG).forEach(([nivel, config]) => {
                const participantesEnNivel = Object.values(participantesCompletos).filter(usuario => {
                    const participaciones = usuario.participacionesTotales || 1; // CORREGIDO: M√≠nimo 1
                    const userNivel = calcularNivel(participaciones).nivel;
                    return userNivel === parseInt(nivel);
                }).length;

                const card = document.createElement('div');
                card.className = `level-card ${config.color}`;
                card.innerHTML = `
                    <div class="level-title">${config.badge} ${config.nombre} ${config.emoji}</div>
                    <div class="nivel-badge ${config.color}" data-nivel="${nivel}">
                        ${config.badge} ${config.nombre} ${config.emoji}
                    </div>
                    <div style="color: white; margin: 10px 0;">
                        <strong>${participantesEnNivel}</strong> jugadores
                    </div>
                    <div class="level-benefits">
                        <strong>Rango:</strong> ${config.participaciones[0]} - ${config.participaciones[1] === Infinity ? '‚àû' : config.participaciones[1]} participaciones<br>
                        <strong>Beneficios:</strong><br>
                        ${config.beneficios.map(b => `‚Ä¢ ${b}`).join('<br>')}
                    </div>
                `;
                levelGrid.appendChild(card);
            });
        }

        function generarRuletaPreview() {
            const ruleta = document.getElementById('ruletaPreview');
            const pointer = ruleta.querySelector('.pointer-preview');
            ruleta.innerHTML = '';
            ruleta.appendChild(pointer);

            if (!sorteoActual) return;

            const cantidad = sorteoActual.cantidadNumeros;
            const angleStep = 360 / cantidad;

            for (let i = 1; i <= cantidad; i++) {
                const slot = document.createElement('div');
                slot.className = 'numero-slot-preview';
                slot.textContent = i;

                // Verificar estado del n√∫mero
                if (participantesData[i]) {
                    if (participantesData[i].pagoVerificado) { // CORREGIDO: Verificar pago, no usuario
                        slot.classList.add('ocupado');
                        slot.textContent = participantesData[i].nombre.split(' ').map(n => n[0]).join('');
                        slot.title = `${participantesData[i].nombre} - Pago Verificado`;
                    } else {
                        slot.classList.add('pendiente');
                        slot.title = 'Pendiente de verificaci√≥n de pago';
                    }
                }

                // Posicionamiento en c√≠rculo
                const angle = (i - 1) * angleStep;
                const radian = (angle * Math.PI) / 180;
                const radius = 140;
                const x = Math.cos(radian) * radius;
                const y = Math.sin(radian) * radius;

                slot.style.left = `calc(50% + ${x}px - 17.5px)`;
                slot.style.top = `calc(50% + ${y}px - 17.5px)`;

                ruleta.appendChild(slot);
            }
        }

        // FUNCI√ìN CORREGIDA: Actualizar participantes con niveles correctos
        function actualizarParticipantes() {
            const container = document.getElementById('participantsList');
            const participantes = Object.entries(participantesData);
            
            if (participantes.length === 0) {
                container.innerHTML = '<p style="color: white; opacity: 0.7; text-align: center;">No hay participantes registrados</p>';
                return;
            }

            container.innerHTML = participantes
                .sort(([a], [b]) => parseInt(a) - parseInt(b))
                .map(([numero, data]) => {
                    // CORREGIDO: Obtener participaciones reales del usuario
                    const usuarioCompleto = participantesCompletos[data.telefono?.replace(/\D/g, '')] || {};
                    const participacionesTotales = usuarioCompleto.participacionesTotales || 1; // CORREGIDO: M√≠nimo 1
                    const nivelInfo = calcularNivel(participacionesTotales);
                    
                    return `
                        <div class="participant-item" data-id="${data.id}">
                            <div class="participant-info">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <strong>#${numero}</strong> - ${data.nombre}
                                    <div class="nivel-badge ${nivelInfo.datos.color}" data-nivel="${nivelInfo.nivel}">
                                        ${nivelInfo.datos.badge} ${nivelInfo.datos.nombre}
                                    </div>
                                </div>
                                <small>üì± ${data.telefono} | üí≥ ${data.codigoReferencia}</small><br>
                                <small>üéØ ${participacionesTotales} participaciones totales</small>
                            </div>
                            <div class="participant-actions">
                                <span class="status-badge ${data.pagoVerificado ? 'status-verified' : 'status-pending'}">
                                    ${data.pagoVerificado ? 'Pago Verificado' : 'Pendiente Pago'}
                                </span>
                                ${!data.pagoVerificado ? `
                                    <button class="btn btn-success" onclick="verificarPago('${data.id}', ${numero})" style="padding: 5px 10px; font-size: 12px;">
                                        ‚úÖ Verificar Pago
                                    </button>
                                ` : ''}
                                <button class="btn btn-warning" onclick="editarParticipante('${data.id}')" style="padding: 5px 10px; font-size: 12px;">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn" onclick="subirNivel('${data.id}')" style="padding: 5px 10px; font-size: 12px;">
                                    ‚¨ÜÔ∏è Subir Nivel
                                </button>
                                <button class="btn btn-warning" onclick="bajarNivel('${data.id}')" style="padding: 5px 10px; font-size: 12px;">
                                    ‚¨áÔ∏è Bajar Nivel
                                </button>
                                <button class="btn btn-danger" onclick="banearParticipante('${data.id}', '${data.nombre}')" style="padding: 5px 10px; font-size: 12px;">
                                    üö´ Banear
                                </button>
                                <button class="btn btn-danger" onclick="eliminarParticipante('${data.id}', ${numero})" style="padding: 5px 10px; font-size: 12px;">
                                    ‚ùå Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            filtrarParticipantes();
        }

        // FUNCI√ìN CORREGIDA: Verificar pago (no usuario)
        window.verificarPago = async function(participanteId, numero) {
            try {
                const participante = Object.values(participantesData).find(p => p.id === participanteId);
                if (!participante) return;

                // Actualizar el estado de pago del participante
                await updateDoc(doc(db, 'participantes', participanteId), {
                    pagoVerificado: true, // CORREGIDO: pagoVerificado en lugar de verificado
                    fechaVerificacionPago: new Date(),
                    verificadoPor: 'admin'
                });

                // CORREGIDO: Actualizar participaciones del usuario sin cambiar nivel autom√°ticamente
                const telefonoLimpio = participante.telefono.replace(/\D/g, '');
                const usuarioExistente = participantesCompletos[telefonoLimpio] || {};
                const nuevasParticipaciones = (usuarioExistente.participacionesTotales || 0) + 1;

                await setDoc(doc(db, 'usuarios', telefonoLimpio), {
                    nombre: participante.nombre,
                    telefono: participante.telefono,
                    participacionesTotales: nuevasParticipaciones,
                    ultimaParticipacion: new Date(),
                    ultimoPago: new Date()
                }, { merge: true });

                mostrarNotificacion(`Pago del participante #${numero} verificado correctamente`, 'success');
            } catch (error) {
                console.error('Error al verificar pago:', error);
                mostrarNotificacion('Error al verificar el pago', 'error');
            }
        }

        // FUNCI√ìN CORREGIDA: Editar participante con datos correctos
        window.editarParticipante = function(participanteId) {
            const participante = Object.values(participantesData).find(p => p.id === participanteId);
            if (!participante) return;

            participanteEditando = participanteId;
            
            // CORREGIDO: Obtener datos reales del usuario
            const usuarioCompleto = participantesCompletos[participante.telefono?.replace(/\D/g, '')] || {};
            const participacionesTotales = usuarioCompleto.participacionesTotales || 1;
            const nivelActual = calcularNivel(participacionesTotales).nivel;
            
            document.getElementById('editNombre').value = participante.nombre;
            document.getElementById('editTelefono').value = participante.telefono;
            document.getElementById('editNivel').value = nivelActual;
            document.getElementById('editParticipaciones').value = participacionesTotales;
            document.getElementById('editEstado').value = participante.pagoVerificado ? 'verificado' : 'pendiente';
            document.getElementById('editNumerosGratis').value = usuarioCompleto.numerosGratisDisponibles || 0;
            document.getElementById('editNotas').value = participante.notas || '';

            document.getElementById('editParticipantModal').style.display = 'block';
        }

        // FUNCI√ìN CORREGIDA: Subir nivel con l√≥gica correcta
        window.subirNivel = async function(participanteId) {
            try {
                const participante = Object.values(participantesData).find(p => p.id === participanteId);
                if (!participante) return;

                const telefonoLimpio = participante.telefono.replace(/\D/g, '');
                const usuarioExistente = participantesCompletos[telefonoLimpio] || {};
                const participacionesActuales = usuarioExistente.participacionesTotales || 1;
                const nivelActual = calcularNivel(participacionesActuales).nivel;

                if (nivelActual >= 5) {
                    mostrarNotificacion('El usuario ya est√° en el nivel m√°ximo (Diamante)', 'warning');
                    return;
                }

                // Calcular participaciones necesarias para subir al siguiente nivel
                const siguienteNivel = nivelActual + 1;
                const participacionesNecesarias = NIVELES_CONFIG[siguienteNivel].participaciones[0];
                const participacionesAOtorgar = Math.max(participacionesNecesarias - participacionesActuales, 1);

                if (confirm(`¬øSubir de nivel a ${participante.nombre}?\nNivel actual: ${NIVELES_CONFIG[nivelActual].nombre}\nNuevo nivel: ${NIVELES_CONFIG[siguienteNivel].nombre}\nSe otorgar√°n +${participacionesAOtorgar} participaciones`)) {
                    await setDoc(doc(db, 'usuarios', telefonoLimpio), {
                        participacionesTotales: participacionesActuales + participacionesAOtorgar,
                        ultimaModificacion: new Date(),
                        modificadoPor: 'admin',
                        razonModificacion: `Nivel subido manualmente de ${NIVELES_CONFIG[nivelActual].nombre} a ${NIVELES_CONFIG[siguienteNivel].nombre}`
                    }, { merge: true });

                    mostrarNotificacion(`Nivel subido: ${NIVELES_CONFIG[nivelActual].nombre} ‚Üí ${NIVELES_CONFIG[siguienteNivel].nombre} (+${participacionesAOtorgar} participaciones)`, 'success');
                }
            } catch (error) {
                console.error('Error al subir nivel:', error);
                mostrarNotificacion('Error al subir nivel', 'error');
            }
        }

        // FUNCI√ìN CORREGIDA: Bajar nivel con l√≥gica correcta
        window.bajarNivel = async function(participanteId) {
            try {
                const participante = Object.values(participantesData).find(p => p.id === participanteId);
                if (!participante) return;

                const telefonoLimpio = participante.telefono.replace(/\D/g, '');
                const usuarioExistente = participantesCompletos[telefonoLimpio] || {};
                const participacionesActuales = usuarioExistente.participacionesTotales || 1;
                const nivelActual = calcularNivel(participacionesActuales).nivel;

                if (nivelActual <= 1) {
                    mostrarNotificacion('El usuario ya est√° en el nivel m√≠nimo (Bronce)', 'warning');
                    return;
                }

                // Calcular participaciones para bajar al nivel anterior
                const nivelAnterior = nivelActual - 1;
                const participacionesMaximasNivelAnterior = NIVELES_CONFIG[nivelAnterior].participaciones[1];
                const nuevasParticipaciones = Math.max(participacionesMaximasNivelAnterior, 1);

                if (confirm(`¬øBajar de nivel a ${participante.nombre}?\nNivel actual: ${NIVELES_CONFIG[nivelActual].nombre}\nNuevo nivel: ${NIVELES_CONFIG[nivelAnterior].nombre}\nParticipaciones: ${participacionesActuales} ‚Üí ${nuevasParticipaciones}`)) {
                    await setDoc(doc(db, 'usuarios', telefonoLimpio), {
                        participacionesTotales: nuevasParticipaciones,
                        ultimaModificacion: new Date(),
                        modificadoPor: 'admin',
                        razonModificacion: `Nivel bajado manualmente de ${NIVELES_CONFIG[nivelActual].nombre} a ${NIVELES_CONFIG[nivelAnterior].nombre}`
                    }, { merge: true });

                    mostrarNotificacion(`Nivel bajado: ${NIVELES_CONFIG[nivelActual].nombre} ‚Üí ${NIVELES_CONFIG[nivelAnterior].nombre}`, 'warning');
                }
            } catch (error) {
                console.error('Error al bajar nivel:', error);
                mostrarNotificacion('Error al bajar nivel', 'error');
            }
        }

        window.banearParticipante = async function(participanteId, nombre) {
            if (confirm(`¬øBanear permanentemente a ${nombre}? Esta acci√≥n NO se puede deshacer.`)) {
                try {
                    const participante = Object.values(participantesData).find(p => p.id === participanteId);
                    const telefonoLimpio = participante.telefono.replace(/\D/g, '');
                    
                    // Banear al participante del sorteo actual
                    await updateDoc(doc(db, 'participantes', participanteId), {
                        baneado: true,
                        fechaBaneo: new Date(),
                        motivoBaneo: prompt('Motivo del baneo (opcional):') || 'Sin motivo especificado',
                        baneadoPor: 'admin'
                    });

                    // Banear al usuario del sistema
                    await setDoc(doc(db, 'usuarios', telefonoLimpio), {
                        baneado: true,
                        fechaBaneo: new Date(),
                        motivoBaneo: prompt('Motivo del baneo (opcional):') || 'Sin motivo especificado',
                        baneadoPor: 'admin'
                    }, { merge: true });

                    mostrarNotificacion(`${nombre} ha sido baneado del sistema`, 'warning');
                } catch (error) {
                    console.error('Error al banear participante:', error);
                    mostrarNotificacion('Error al banear participante', 'error');
                }
            }
        }

        window.eliminarParticipante = async function(participanteId, numero) {
            if (confirm(`¬øEliminar permanentemente al participante #${numero}? Esta acci√≥n NO se puede deshacer.`)) {
                try {
                    await deleteDoc(doc(db, 'participantes', participanteId));
                    mostrarNotificacion(`Participante #${numero} eliminado permanentemente`, 'success');
                } catch (error) {
                    console.error('Error al eliminar participante:', error);
                    mostrarNotificacion('Error al eliminar participante', 'error');
                }
            }
        }

        // FORMULARIO CORREGIDO: Manejo del formulario de edici√≥n
        document.getElementById('editParticipantForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!participanteEditando) return;

            try {
                const participante = Object.values(participantesData).find(p => p.id === participanteEditando);
                const telefonoLimpio = participante.telefono.replace(/\D/g, '');
                
                // CORREGIDO: Actualizar datos del participante
                const datosParticipante = {
                    nombre: document.getElementById('editNombre').value,
                    telefono: document.getElementById('editTelefono').value,
                    pagoVerificado: document.getElementById('editEstado').value === 'verificado',
                    notas: document.getElementById('editNotas').value,
                    ultimaEdicion: new Date(),
                    editadoPor: 'admin'
                };

                // CORREGIDO: Actualizar datos del usuario
                const datosUsuario = {
                    nombre: document.getElementById('editNombre').value,
                    telefono: document.getElementById('editTelefono').value,
                    participacionesTotales: parseInt(document.getElementById('editParticipaciones').value),
                    numerosGratisDisponibles: parseInt(document.getElementById('editNumerosGratis').value),
                    baneado: document.getElementById('editEstado').value === 'baneado',
                    ultimaEdicion: new Date(),
                    editadoPor: 'admin'
                };

                await updateDoc(doc(db, 'participantes', participanteEditando), datosParticipante);
                await setDoc(doc(db, 'usuarios', telefonoLimpio), datosUsuario, { merge: true });

                mostrarNotificacion('Participante actualizado correctamente', 'success');
                cerrarEditModal();
            } catch (error) {
                console.error('Error al actualizar participante:', error);
                mostrarNotificacion('Error al actualizar participante', 'error');
            }
        });

        window.cerrarEditModal = function() {
            document.getElementById('editParticipantModal').style.display = 'none';
            participanteEditando = null;
        }

        // Configurar sorteo
        document.getElementById('sorteoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const cantidad = parseInt(document.getElementById('cantidadNumeros').value);
            const premio = parseInt(document.getElementById('premioSorteo').value);
            const fecha = document.getElementById('fechaSorteo').value;
            const hora = document.getElementById('horaSorteo').value;
            const tipo = document.getElementById('tipoSorteo').value;

            if (cantidad < 5 || cantidad > 50) {
                mostrarNotificacion('La cantidad de n√∫meros debe estar entre 5 y 50', 'error');
                return;
            }

            if (sorteoActual && Object.keys(participantesData).length > 0) {
                if (!confirm('Hay participantes registrados. ¬øCrear un nuevo sorteo? Se perder√°n los datos actuales.')) {
                    return;
                }
                
                // Limpiar participantes actuales
                const participantesQuery = query(collection(db, 'participantes'), where('sorteoId', '==', 'activo'));
                const participantesSnapshot = await getDocs(participantesQuery);
                
                for (const doc of participantesSnapshot.docs) {
                    await deleteDoc(doc.ref);
                }
            }

            try {
                await setDoc(doc(db, 'sorteos', 'activo'), {
                    cantidadNumeros: cantidad,
                    premio: premio,
                    fecha: fecha,
                    hora: hora,
                    tipo: tipo,
                    estado: 'activo',
                    timestamp: new Date(),
                    creadoPor: 'admin'
                });

                mostrarNotificacion('Sorteo configurado correctamente', 'success');
            } catch (error) {
                console.error('Error al configurar sorteo:', error);
                mostrarNotificacion('Error al configurar el sorteo', 'error');
            }
        });

        // Funciones de grabaci√≥n de GIF
        window.iniciarGrabacion = async function() {
            try {
                const ruleta = document.getElementById('ruletaPreview');
                const btnIniciar = document.getElementById('btnIniciarGrabacion');
                const btnGirar = document.getElementById('btnGirarGrabando');
                const recordingStatus = document.getElementById('recordingStatus');

                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' }
                });

                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                recordedChunks = [];

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = function() {
                    procesarGrabacion();
                };

                mediaRecorder.start(100);

                isRecording = true;
                btnIniciar.disabled = true;
                btnIniciar.textContent = 'üî¥ Grabando...';
                btnGirar.disabled = false;
                recordingStatus.classList.add('active');
                ruleta.classList.add('recording');

                mostrarNotificacion('Grabaci√≥n iniciada - Ahora puedes girar la ruleta', 'success');

            } catch (error) {
                console.error('Error al iniciar grabaci√≥n:', error);
                mostrarNotificacion('Error al acceder a la captura de pantalla', 'error');
            }
        }

        window.girarRuletaConGrabacion = async function() {
            const participantesVerificados = Object.entries(participantesData).filter(([num, data]) => data.pagoVerificado); // CORREGIDO
            
            if (participantesVerificados.length === 0) {
                mostrarNotificacion('No hay participantes con pago verificado para el sorteo', 'error');
                return;
            }

            if (!confirm(`¬øRealizar sorteo con grabaci√≥n? ${participantesVerificados.length} participantes con pago verificado.`)) {
                return;
            }

            const ruleta = document.getElementById('ruletaPreview');
            const btnGirar = document.getElementById('btnGirarGrabando');
            
            btnGirar.disabled = true;
            btnGirar.innerHTML = '<span class="loading-spinner"></span> Girando y grabando...';
            
            ruleta.classList.add('spinning');

            setTimeout(async () => {
                const [numeroGanador, datosGanador] = participantesVerificados[Math.floor(Math.random() * participantesVerificados.length)];

                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }

                // CORREGIDO: Calcular nivel real del ganador
                const telefonoLimpio = datosGanador.telefono.replace(/\D/g, '');
                const usuarioGanador = participantesCompletos[telefonoLimpio] || {};
                const participacionesTotales = usuarioGanador.participacionesTotales || 1;
                const nivelGanador = calcularNivel(participacionesTotales);

                document.getElementById('winnerDisplay').classList.add('show');
                document.getElementById('winnerText').innerHTML = `
                    <strong>${datosGanador.nombre}</strong><br>
                    N√∫mero: #${numeroGanador}<br>
                    Premio: ${sorteoActual.premio} USD<br>
                    Tel√©fono: ${datosGanador.telefono}<br>
                    Nivel: ${nivelGanador.datos.badge} ${nivelGanador.datos.nombre}
                `;

                try {
                    // Guardar resultado
                    await addDoc(collection(db, 'resultados'), {
                        fecha: sorteoActual.fecha,
                        hora: sorteoActual.hora,
                        tipo: sorteoActual.tipo || 'normal',
                        ganadorNombre: datosGanador.nombre,
                        ganadorNumero: parseInt(numeroGanador),
                        ganadorTelefono: datosGanador.telefono,
                        ganadorNivel: nivelGanador.nivel,
                        premio: sorteoActual.premio,
                        totalParticipantes: participantesVerificados.length,
                        estado: 'finalizado',
                        timestamp: new Date(),
                        tieneGrabacion: true
                    });

                    // Actualizar sorteo como finalizado
                    await updateDoc(doc(db, 'sorteos', 'activo'), {
                        estado: 'finalizado',
                        ganador: datosGanador.nombre,
                        ganadorNombre: datosGanador.nombre,
                        ganadorNumero: parseInt(numeroGanador),
                        ganadorNivel: nivelGanador.nivel,
                        fechaFinalizacion: new Date()
                    });

                    // CORREGIDO: Actualizar estad√≠sticas del ganador
                    await setDoc(doc(db, 'usuarios', telefonoLimpio), {
                        ultimaGanancia: new Date(),
                        premiosGanados: (usuarioGanador.premiosGanados || 0) + 1,
                        totalGanado: (usuarioGanador.totalGanado || 0) + sorteoActual.premio
                    }, { merge: true });

                    // Mensaje de WhatsApp mejorado
                    const mensajeGanador = `üéâ ¬°TENEMOS GANADOR! üéâ

üèÜ Sorteo Ruleta Dorada ${sorteoActual.tipo?.toUpperCase() || 'NORMAL'}
üë§ Ganador: ${datosGanador.nombre}
üé≤ N√∫mero ganador: #${numeroGanador}
üí∞ Premio: ${sorteoActual.premio} USD
üì± Contacto: ${datosGanador.telefono}

üèÖ Nivel del ganador: ${nivelGanador.datos.badge} ${nivelGanador.datos.nombre} ${nivelGanador.datos.emoji}
üéØ Participaciones totales: ${participacionesTotales}

¬°Felicidades al ganador! üéä
El pago se realizar√° en las pr√≥ximas 2 horas.

üìπ GIF del sorteo gener√°ndose...
¬°Mantente atento al pr√≥ximo sorteo!

#RuletaDorada #Ganador #${nivelGanador.datos.nombre}`;

                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(mensajeGanador);
                        mostrarNotificacion(`üéâ ¬°Ganador: ${datosGanador.nombre}!\nMensaje copiado al portapapeles`, 'success');
                    }

                } catch (error) {
                    console.error('Error al guardar resultado:', error);
                    mostrarNotificacion('Error al guardar el resultado del sorteo', 'error');
                }

                // Restaurar UI
                ruleta.classList.remove('spinning', 'recording');
                btnGirar.disabled = false;
                btnGirar.textContent = 'üé¨ Girar y Grabar';
                document.getElementById('recordingStatus').classList.remove('active');
                document.getElementById('btnIniciarGrabacion').disabled = false;
                document.getElementById('btnIniciarGrabacion').textContent = 'üìπ Iniciar Grabaci√≥n';
                isRecording = false;

            }, 4000);
        }

        function procesarGrabacion() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const videoURL = URL.createObjectURL(blob);
            const gifResult = document.getElementById('gifResult');
            
            gifResult.src = videoURL;
            gifResult.style.display = 'block';
            
            const a = document.createElement('a');
            a.href = videoURL;
            a.download = `sorteo-${new Date().toISOString().split('T')[0]}.webm`;
            a.textContent = 'Descargar grabaci√≥n';
            a.style.display = 'block';
            a.style.textAlign = 'center';
            a.style.color = '#3498db';
            a.style.margin = '10px 0';
            
            const container = document.querySelector('.panel .gif-preview').parentNode;
            container.appendChild(a);
            
            mostrarNotificacion('¬°Grabaci√≥n del sorteo completada!', 'success');
        }

        // Funciones administrativas avanzadas
        window.respaldarDatos = async function() {
            try {
                const datos = {
                    sorteoActual: sorteoActual,
                    participantes: participantesData,
                    historial: historialData,
                    usuarios: participantesCompletos,
                    fecha: new Date().toISOString(),
                    version: '2.0'
                };

                const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ruleta-dorada-respaldo-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                mostrarNotificacion('Respaldo de datos descargado correctamente', 'success');
            } catch (error) {
                console.error('Error al respaldar datos:', error);
                mostrarNotificacion('Error al crear respaldo', 'error');
            }
        }

        window.exportarEstadisticas = function() {
            try {
                let csv = 'Nombre,Telefono,Participaciones,Nivel,Estado,Ultimo Sorteo\n';
                
                Object.values(participantesCompletos).forEach(usuario => {
                    const participaciones = usuario.participacionesTotales || 1;
                    const nivel = calcularNivel(participaciones);
                    csv += `"${usuario.nombre || 'N/A'}","${usuario.telefono || 'N/A'}",${participaciones},"${nivel.datos.nombre}","${usuario.baneado ? 'Baneado' : 'Activo'}","${usuario.ultimaParticipacion || 'N/A'}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `estadisticas-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                mostrarNotificacion('Estad√≠sticas exportadas correctamente', 'success');
            } catch (error) {
                console.error('Error al exportar estad√≠sticas:', error);
                mostrarNotificacion('Error al exportar estad√≠sticas', 'error');
            }
        }

        window.limpiarHistorial = async function() {
            if (confirm('‚ö†Ô∏è ¬øEliminar TODOS los resultados hist√≥ricos? Esta acci√≥n NO se puede deshacer.')) {
                const confirmar = prompt('Escribe "ELIMINAR TODO" para confirmar:');
                if (confirmar === 'ELIMINAR TODO') {
                    try {
                        const resultadosQuery = query(collection(db, 'resultados'));
                        const resultadosSnapshot = await getDocs(resultadosQuery);
                        
                        for (const doc of resultadosSnapshot.docs) {
                            await deleteDoc(doc.ref);
                        }
                        
                        mostrarNotificacion('Historial eliminado completamente', 'success');
                    } catch (error) {
                        console.error('Error al limpiar historial:', error);
                        mostrarNotificacion('Error al limpiar el historial', 'error');
                    }
                } else {
                    mostrarNotificacion('Acci√≥n cancelada - Texto de confirmaci√≥n incorrecto', 'warning');
                }
            }
        }

        // Gesti√≥n de niveles
        window.abrirGestionNiveles = function() {
            document.getElementById('nivelesModal').style.display = 'block';
            cargarConfiguracionNiveles();
        }

        window.cerrarNivelesModal = function() {
            document.getElementById('nivelesModal').style.display = 'none';
        }

        function cargarConfiguracionNiveles() {
            Object.entries(NIVELES_CONFIG).forEach(([nivel, config]) => {
                const [min, max] = config.participaciones;
                document.getElementById(`nivel${nivel}Min`).value = min;
                if (max !== Infinity) {
                    document.getElementById(`nivel${nivel}Max`).value = max;
                }
            });
        }

        window.guardarConfigNiveles = function() {
            mostrarNotificacion('Configuraci√≥n de niveles guardada', 'success');
        }

        window.resetearNiveles = function() {
            if (confirm('¬øResetear configuraci√≥n de niveles a valores por defecto?')) {
                cargarConfiguracionNiveles();
                mostrarNotificacion('Configuraci√≥n reseteada a valores por defecto', 'warning');
            }
        }

        window.recalcularNiveles = async function() {
            if (confirm('¬øRecalcular los niveles de todos los usuarios? Esto puede tardar unos momentos.')) {
                try {
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.innerHTML = '<div class="progress-fill" style="width: 0%"></div>';
                    document.querySelector('.panel h3').after(progressBar);

                    for (let i = 0; i <= 100; i += 10) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        progressBar.querySelector('.progress-fill').style.width = i + '%';
                    }

                    progressBar.remove();
                    cargarLevelGrid();
                    mostrarNotificacion('Niveles recalculados correctamente', 'success');
                } catch (error) {
                    console.error('Error al recalcular niveles:', error);
                    mostrarNotificacion('Error al recalcular niveles', 'error');
                }
            }
        }

        window.otorgarBeneficios = function() {
            const beneficios = `üéÅ BENEFICIOS OTORGADOS POR NIVEL:

üèÖ BRONCE (${Object.values(participantesCompletos).filter(u => calcularNivel(u.participacionesTotales || 1).nivel === 1).length} usuarios):
‚Ä¢ N√∫meros gratis disponibles actualizados
‚Ä¢ Acceso a grupo WhatsApp exclusivo

‚ö°Ô∏è PLATA (${Object.values(participantesCompletos).filter(u => calcularNivel(u.participacionesTotales || 1).nivel === 2).length} usuarios):
‚Ä¢ Reservas de n√∫meros favoritos activadas
‚Ä¢ Sorteo mensual $100 programado

üî• ORO (${Object.values(participantesCompletos).filter(u => calcularNivel(u.participacionesTotales || 1).nivel === 3).length} usuarios):
‚Ä¢ 2 n√∫meros gratis por semana otorgados
‚Ä¢ Descuento 20% aplicado autom√°ticamente

üëë PLATINO (${Object.values(participantesCompletos).filter(u => calcularNivel(u.participacionesTotales || 1).nivel === 4).length} usuarios):
‚Ä¢ Acceso VIP exclusivo activado
‚Ä¢ Soporte prioritario configurado

üíé DIAMANTE (${Object.values(participantesCompletos).filter(u => calcularNivel(u.participacionesTotales || 1).nivel === 5).length} usuarios):
‚Ä¢ Sorteos exclusivos mensuales programados
‚Ä¢ Reconocimiento especial otorgado

¬°Beneficios aplicados autom√°ticamente!`;

            alert(beneficios);
            mostrarNotificacion('Beneficios por nivel otorgados correctamente', 'success');
        }

        // Funciones auxiliares
        window.pausarSorteo = async function() {
            if (!sorteoActual) {
                mostrarNotificacion('No hay sorteo activo para pausar', 'warning');
                return;
            }

            if (confirm('¬øPausar el sorteo actual? Los usuarios no podr√°n participar temporalmente.')) {
                try {
                    await updateDoc(doc(db, 'sorteos', 'activo'), {
                        estado: 'pausado',
                        fechaPausa: new Date()
                    });
                    mostrarNotificacion('Sorteo pausado correctamente', 'warning');
                } catch (error) {
                    console.error('Error al pausar sorteo:', error);
                    mostrarNotificacion('Error al pausar el sorteo', 'error');
                }
            }
        }

        window.finalizarSorteo = async function() {
            if (!sorteoActual) {
                mostrarNotificacion('No hay sorteo activo para finalizar', 'warning');
                return;
            }

            if (confirm('¬øFinalizar el sorteo sin realizar el sorteo? Esto eliminar√° todos los participantes.')) {
                try {
                    // Mover sorteo a historial sin ganador
                    await addDoc(collection(db, 'resultados'), {
                        fecha: sorteoActual.fecha,
                        hora: sorteoActual.hora,
                        tipo: sorteoActual.tipo || 'normal',
                        ganadorNombre: 'Sorteo cancelado',
                        ganadorNumero: 0,
                        premio: sorteoActual.premio,
                        totalParticipantes: Object.keys(participantesData).length,
                        estado: 'cancelado',
                        timestamp: new Date()
                    });

                    // Eliminar sorteo activo
                    await deleteDoc(doc(db, 'sorteos', 'activo'));

                    // Limpiar participantes
                    const participantesQuery = query(collection(db, 'participantes'), where('sorteoId', '==', 'activo'));
                    const participantesSnapshot = await getDocs(participantesQuery);
                    
                    for (const doc of participantesSnapshot.docs) {
                        await deleteDoc(doc.ref);
                    }

                    mostrarNotificacion('Sorteo finalizado y cancelado correctamente', 'success');
                } catch (error) {
                    console.error('Error al finalizar sorteo:', error);
                    mostrarNotificacion('Error al finalizar el sorteo', 'error');
                }
            }
        }

        function cargarHistorial() {
            const tbody = document.querySelector('#historialTable tbody');
            
            if (historialData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; opacity: 0.7;">No hay historial disponible</td></tr>';
                return;
            }

            tbody.innerHTML = historialData.map(resultado => {
                const fecha = resultado.timestamp ? new Date(resultado.timestamp.seconds * 1000) : new Date();
                const nivelGanador = resultado.ganadorNivel ? NIVELES_CONFIG[resultado.ganadorNivel] : null;
                
                return `
                    <tr>
                        <td>${fecha.toLocaleDateString()}</td>
                        <td>${resultado.hora}</td>
                        <td>
                            <span class="status-badge ${resultado.tipo === 'vip' ? 'status-verified' : 'status-pending'}">
                                ${resultado.tipo?.toUpperCase() || 'NORMAL'}
                            </span>
                        </td>
                        <td>${resultado.totalParticipantes || 0}</td>
                        <td>${resultado.ganadorNombre}</td>
                        <td>${resultado.ganadorNumero > 0 ? '#' + resultado.ganadorNumero : 'N/A'}</td>
                        <td>${resultado.premio}</td>
                        <td>
                            ${nivelGanador ? `
                                <div class="nivel-badge ${nivelGanador.color}" style="font-size: 10px; padding: 3px 8px;">
                                    ${nivelGanador.badge} ${nivelGanador.nombre}
                                </div>
                            ` : 'N/A'}
                        </td>
                        <td>
                            <span class="status-badge ${resultado.estado === 'finalizado' ? 'status-verified' : 'status-pending'}">
                                ${resultado.estado}
                            </span>
                        </td>
                        <td>
                            ${resultado.tieneGrabacion ? 'üìπ' : ''}
                            <button class="btn" onclick="verDetalles('${resultado.id}')" style="padding: 3px 8px; font-size: 10px;">
                                üëÅÔ∏è Ver
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.verDetalles = function(resultadoId) {
            const resultado = historialData.find(r => r.id === resultadoId);
            if (!resultado) return;

            const detalles = `üìä DETALLES DEL SORTEO

üìÖ Fecha: ${new Date(resultado.timestamp?.seconds * 1000 || resultado.fecha).toLocaleString()}
üé≤ Tipo: ${resultado.tipo?.toUpperCase() || 'NORMAL'}
üë• Participantes: ${resultado.totalParticipantes}
üèÜ Ganador: ${resultado.ganadorNombre}
üéØ N√∫mero: #${resultado.ganadorNumero}
üí∞ Premio: ${resultado.premio}
üì± Tel√©fono: ${resultado.ganadorTelefono || 'N/A'}
${resultado.ganadorNivel ? `üèÖ Nivel: ${NIVELES_CONFIG[resultado.ganadorNivel]?.nombre || 'N/A'}` : ''}
üìä Estado: ${resultado.estado}
${resultado.tieneGrabacion ? 'üìπ Grabaci√≥n: Disponible' : ''}`;

            alert(detalles);
        }

        window.filtrarHistorial = function() {
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;
            
            // En un sistema real, aqu√≠ se filtrar√≠an los datos
            mostrarNotificacion(`Filtros aplicados: ${fechaDesde} - ${fechaHasta}`, 'info');
        }

        // Sistema de notificaciones
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${tipo}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${tipo === 'success' ? '#27ae60' : tipo === 'error' ? '#e74c3c' : tipo === 'warning' ? '#f39c12' : '#3498db'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 350px;
                word-wrap: break-word;
            `;
            
            notification.textContent = mensaje;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        // CSS para animaciones de notificaci√≥n
        const notificationStyles = document.createElement('style');
        notificationStyles.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(notificationStyles);

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const nivelesModal = document.getElementById('nivelesModal');
            const editModal = document.getElementById('editParticipantModal');
            
            if (event.target === nivelesModal) {
                cerrarNivelesModal();
            }
            if (event.target === editModal) {
                cerrarEditModal();
            }
        }

        // Manejo de teclas
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const nivelesModal = document.getElementById('nivelesModal');
                const editModal = document.getElementById('editParticipantModal');
                
                if (nivelesModal.style.display === 'block') {
                    cerrarNivelesModal();
                }
                if (editModal.style.display === 'block') {
                    cerrarEditModal();
                }
            }
        });

        // Auto-refresh cada 30 segundos
        setInterval(() => {
            console.log('Auto-actualizando datos del admin panel...', new Date().toLocaleTimeString());
            actualizarStatsAvanzadas();
        }, 30000);

        // Funci√≥n para generar reportes avanzados
        window.generarReporteCompleto = function() {
            const fecha = new Date().toLocaleDateString('es-ES');
            const hora = new Date().toLocaleTimeString('es-ES');
            
            let reporte = `üìä REPORTE COMPLETO - RULETA DORADA
üìÖ Generado: ${fecha} ${hora}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìà ESTAD√çSTICAS GENERALES:
‚Ä¢ Total participantes activos: ${Object.keys(participantesData).length}
‚Ä¢ Participantes verificados: ${Object.values(participantesData).filter(p => p.verificado).length}
‚Ä¢ Ingresos del sorteo actual: ${Object.values(participantesData).filter(p => p.verificado).length * 10} USD
‚Ä¢ Total usuarios registrados: ${Object.keys(participantesCompletos).length}

üèÜ DISTRIBUCI√ìN POR NIVELES:`;

            Object.entries(NIVELES_CONFIG).forEach(([nivel, config]) => {
                const usuariosEnNivel = Object.values(participantesCompletos).filter(usuario => {
                    const participaciones = usuario.participacionesTotales || 0;
                    const userNivel = calcularNivel(participaciones).nivel;
                    return userNivel === parseInt(nivel);
                }).length;

                reporte += `
‚Ä¢ ${config.badge} ${config.nombre}: ${usuariosEnNivel} usuarios`;
            });

            reporte += `

üìä SORTEO ACTUAL:`;
            if (sorteoActual) {
                reporte += `
‚Ä¢ Estado: ${sorteoActual.estado?.toUpperCase()}
‚Ä¢ Tipo: ${sorteoActual.tipo?.toUpperCase() || 'NORMAL'}
‚Ä¢ Premio: ${sorteoActual.premio} USD
‚Ä¢ N√∫meros totales: ${sorteoActual.cantidadNumeros}
‚Ä¢ N√∫meros vendidos: ${Object.keys(participantesData).length}
‚Ä¢ N√∫meros disponibles: ${sorteoActual.cantidadNumeros - Object.keys(participantesData).length}
‚Ä¢ Fecha programada: ${sorteoActual.fecha} ${sorteoActual.hora}`;
            } else {
                reporte += `
‚Ä¢ No hay sorteo activo`;
            }

            reporte += `

üìã √öLTIMOS 5 RESULTADOS:`;
            historialData.slice(0, 5).forEach((resultado, index) => {
                const fecha = resultado.timestamp ? new Date(resultado.timestamp.seconds * 1000) : new Date();
                const nivel = resultado.ganadorNivel ? NIVELES_CONFIG[resultado.ganadorNivel] : null;
                reporte += `
${index + 1}. ${fecha.toLocaleDateString()} - ${resultado.ganadorNombre} (#${resultado.ganadorNumero}) - ${resultado.premio}${nivel ? ` - ${nivel.nombre}` : ''}`;
            });

            reporte += `

üí° RECOMENDACIONES:
‚Ä¢ Promover participaci√≥n en niveles inferiores
‚Ä¢ Considerar sorteos especiales para usuarios VIP
‚Ä¢ Revisar estrategias de retenci√≥n de jugadores
‚Ä¢ Analizar patrones de participaci√≥n por horarios

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üè¢ GStar INK - Sistema Ruleta Dorada Pro
üìß Reporte generado autom√°ticamente`;

            // Crear archivo de texto
            const blob = new Blob([reporte], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte-completo-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            mostrarNotificacion('Reporte completo generado y descargado', 'success');
        }

        // Funci√≥n para backup autom√°tico
        function configurarBackupAutomatico() {
            // Backup autom√°tico cada 24 horas
            setInterval(() => {
                if (Object.keys(participantesData).length > 0 || historialData.length > 0) {
                    respaldarDatos();
                    console.log('Backup autom√°tico realizado:', new Date().toLocaleString());
                }
            }, 24 * 60 * 60 * 1000); // 24 horas
        }

        // Funci√≥n para detectar patrones sospechosos
        function detectarPatronesSospechosos() {
            const patronesSospechosos = [];
            
            // Detectar m√∫ltiples participaciones desde el mismo IP
            const ipsConteo = {};
            Object.values(participantesData).forEach(p => {
                const ip = p.ip || 'desconocida';
                ipsConteo[ip] = (ipsConteo[ip] || 0) + 1;
            });

            Object.entries(ipsConteo).forEach(([ip, count]) => {
                if (count > 3 && ip !== 'desconocida') {
                    patronesSospechosos.push(`üö® IP sospechosa: ${ip} (${count} participaciones)`);
                }
            });

            // Detectar tel√©fonos similares
            const telefonos = Object.values(participantesData).map(p => p.telefonoNumerico || '').filter(t => t.length > 0);
            const telefonosSimilares = {};
            
            telefonos.forEach(tel => {
                const base = tel.substring(0, tel.length - 1); // Sin √∫ltimo d√≠gito
                telefonosSimilares[base] = (telefonosSimilares[base] || 0) + 1;
            });

            Object.entries(telefonosSimilares).forEach(([base, count]) => {
                if (count > 2) {
                    patronesSospechosos.push(`‚ö†Ô∏è Tel√©fonos similares: ${base}xxx (${count} n√∫meros)`);
                }
            });

            if (patronesSospechosos.length > 0) {
                const alerta = `üîç PATRONES DETECTADOS:\n\n${patronesSospechosos.join('\n')}\n\nRevisa manualmente estas participaciones.`;
                console.warn('Patrones sospechosos detectados:', patronesSospechosos);
                
                // Mostrar alerta solo si hay muchos patrones
                if (patronesSospechosos.length >= 3) {
                    setTimeout(() => {
                        if (confirm(`${alerta}\n\n¬øAbrir gesti√≥n de participantes para revisar?`)) {
                            document.getElementById('buscarParticipante').focus();
                        }
                    }, 2000);
                }
            }
        }

        // Funci√≥n para optimizaci√≥n de rendimiento
        function optimizarRendimiento() {
            // Limpiar eventos duplicados
            document.removeEventListener('keydown', arguments.callee);
            
            // Optimizar consultas a Firebase
            const observadores = [];
            
            // Limitar actualizaciones de UI
            let ultimaActualizacion = 0;
            const INTERVALO_MINIMO = 1000; // 1 segundo

            function actualizarConThrottle(callback) {
                const ahora = Date.now();
                if (ahora - ultimaActualizacion > INTERVALO_MINIMO) {
                    callback();
                    ultimaActualizacion = ahora;
                }
            }

            // Aplicar throttling a funciones cr√≠ticas
            const actualizarParticipantesThrottled = () => actualizarConThrottle(actualizarParticipantes);
            const actualizarStatsThrottled = () => actualizarConThrottle(actualizarStats);
            
            // Reemplazar funciones originales
            window.actualizarParticipantesOptimizado = actualizarParticipantesThrottled;
            window.actualizarStatsOptimizado = actualizarStatsThrottled;
        }

        // Funci√≥n para modo mantenimiento
        window.activarModoMantenimiento = async function() {
            if (confirm('‚ö†Ô∏è ¬øActivar modo mantenimiento? Esto pausar√° todos los sorteos y notificar√° a los usuarios.')) {
                try {
                    await setDoc(doc(db, 'sistema', 'configuracion'), {
                        modoMantenimiento: true,
                        fechaActivacion: new Date(),
                        mensaje: 'Sistema en mantenimiento. Regresaremos pronto.'
                    });

                    mostrarNotificacion('Modo mantenimiento ACTIVADO', 'warning');
                    
                    // Cambiar apariencia del panel
                    document.body.style.filter = 'grayscale(50%)';
                    document.querySelector('.header').style.background = 'rgba(243, 156, 18, 0.3)';
                    
                } catch (error) {
                    console.error('Error al activar modo mantenimiento:', error);
                    mostrarNotificacion('Error al activar modo mantenimiento', 'error');
                }
            }
        }

        window.desactivarModoMantenimiento = async function() {
            try {
                await setDoc(doc(db, 'sistema', 'configuracion'), {
                    modoMantenimiento: false,
                    fechaDesactivacion: new Date()
                });

                mostrarNotificacion('Modo mantenimiento DESACTIVADO', 'success');
                
                // Restaurar apariencia
                document.body.style.filter = 'none';
                document.querySelector('.header').style.background = 'rgba(255, 255, 255, 0.1)';
                
            } catch (error) {
                console.error('Error al desactivar modo mantenimiento:', error);
                mostrarNotificacion('Error al desactivar modo mantenimiento', 'error');
            }
        }

        // Inicializar funciones avanzadas
        setTimeout(() => {
            optimizarRendimiento();
            configurarBackupAutomatico();
            
            // Detectar patrones cada 5 minutos
            setInterval(detectarPatronesSospechosos, 5 * 60 * 1000);
            
            mostrarNotificacion('Panel de administraci√≥n avanzado cargado correctamente', 'success');
        }, 2000);

        // Funci√≥n de emergencia para resetear todo
        window.resetearSistemaCompleto = async function() {
            const confirmacion1 = prompt('‚õî RESET TOTAL DEL SISTEMA ‚õî\n\nEsto eliminar√°:\n‚Ä¢ Todos los sorteos\n‚Ä¢ Todos los participantes\n‚Ä¢ Todo el historial\n‚Ä¢ Todas las configuraciones\n\nEscribe "RESET COMPLETO" para continuar:');
            
            if (confirmacion1 !== 'RESET COMPLETO') {
                mostrarNotificacion('Reset cancelado - Confirmaci√≥n incorrecta', 'warning');
                return;
            }

            const confirmacion2 = confirm('üö® √öLTIMA ADVERTENCIA üö®\n\nEsta acci√≥n es IRREVERSIBLE.\n¬øContinuar con el reset total?');
            
            if (!confirmacion2) {
                mostrarNotificacion('Reset cancelado por el usuario', 'warning');
                return;
            }

            try {
                // Mostrar progreso
                const progressContainer = document.createElement('div');
                progressContainer.innerHTML = `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 30px; border-radius: 15px; z-index: 10000; text-align: center;">
                        <h3>üîÑ Reseteando Sistema...</h3>
                        <div class="progress-bar" style="width: 300px; margin: 20px 0;">
                            <div class="progress-fill" id="resetProgress" style="width: 0%"></div>
                        </div>
                        <p id="resetStatus">Iniciando reset...</p>
                    </div>
                `;
                document.body.appendChild(progressContainer);

                const progress = document.getElementById('resetProgress');
                const status = document.getElementById('resetStatus');

                // Paso 1: Eliminar participantes
                status.textContent = 'Eliminando participantes...';
                progress.style.width = '20%';
                const participantesSnapshot = await getDocs(collection(db, 'participantes'));
                for (const doc of participantesSnapshot.docs) {
                    await deleteDoc(doc.ref);
                }

                // Paso 2: Eliminar sorteos
                status.textContent = 'Eliminando sorteos...';
                progress.style.width = '40%';
                const sorteosSnapshot = await getDocs(collection(db, 'sorteos'));
                for (const doc of sorteosSnapshot.docs) {
                    await deleteDoc(doc.ref);
                }

                // Paso 3: Eliminar historial
                status.textContent = 'Eliminando historial...';
                progress.style.width = '60%';
                const historialSnapshot = await getDocs(collection(db, 'resultados'));
                for (const doc of historialSnapshot.docs) {
                    await deleteDoc(doc.ref);
                }

                // Paso 4: Eliminar usuarios
                status.textContent = 'Eliminando usuarios...';
                progress.style.width = '80%';
                const usuariosSnapshot = await getDocs(collection(db, 'usuarios'));
                for (const doc of usuariosSnapshot.docs) {
                    await deleteDoc(doc.ref);
                }

                // Paso 5: Reset configuraci√≥n
                status.textContent = 'Reseteando configuraci√≥n...';
                progress.style.width = '100%';
                await setDoc(doc(db, 'sistema', 'configuracion'), {
                    resetTotal: true,
                    fechaReset: new Date(),
                    version: '2.0'
                });

                setTimeout(() => {
                    document.body.removeChild(progressContainer);
                    alert('‚úÖ SISTEMA RESETEADO COMPLETAMENTE\n\nTodos los datos han sido eliminados.\nRecarga la p√°gina para continuar.');
                    location.reload();
                }, 1000);

            } catch (error) {
                console.error('Error durante el reset:', error);
                mostrarNotificacion('Error durante el reset del sistema', 'error');
                if (document.body.contains(progressContainer)) {
                    document.body.removeChild(progressContainer);
                }
            }
        }

        // Agregar bot√≥n de reset al header (solo para desarrollo)
        const resetButton = document.createElement('button');
        resetButton.className = 'quick-action';
        resetButton.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
        resetButton.innerHTML = '‚õî RESET TOTAL';
        resetButton.onclick = resetearSistemaCompleto;
        document.querySelector('.admin-actions').appendChild(resetButton);

        // Agregar bot√≥n de reporte completo
        const reporteButton = document.createElement('button');
        reporteButton.className = 'quick-action';
        reporteButton.style.background = 'linear-gradient(45deg, #17a2b8, #138496)';
        reporteButton.innerHTML = 'üìã Reporte Completo';
        reporteButton.onclick = generarReporteCompleto;
        document.querySelector('.admin-actions').appendChild(reporteButton);

        // Agregar botones de mantenimiento
        const mantenimientoButton = document.createElement('button');
        mantenimientoButton.className = 'quick-action';
        mantenimientoButton.innerHTML = 'üîß Modo Mantenimiento';
        mantenimientoButton.onclick = activarModoMantenimiento;
        document.querySelector('.admin-actions').appendChild(mantenimientoButton);

        console.log('üéØ Panel de Administraci√≥n Pro v2.0 cargado completamente');
        console.log('‚úÖ Funciones disponibles: Grabaci√≥n GIF, Gesti√≥n de Niveles, Backup Autom√°tico, Detecci√≥n de Patrones');
        console.log('üîß Modo Desarrollador: Reset Total, Reportes Avanzados, An√°lisis de Usuarios');

    </script>
</body>
</html>

                
